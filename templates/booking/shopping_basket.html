{% extends "base.html" %}
{% load static %}
{% load bookingtags %}

{% block extra_head %}
{% include 'common/includes/ajax_head.html' %}
{% endblock %}

{% block content %}


<div class="container-fluid">
    <div class="row">
        <h1 class="mt-3">Shopping Basket</h1>
    
        {% if unpaid_block_info %}

            <table class="table table-bordered">
              <thead class="thead-light">
                <tr>
                  <th>Block</th>
                  <th>Cost</th>
                </tr>
              </thead>
              <tbody>
                {% for block_info in unpaid_block_info %}
                    <tr id="cart-row-{{ block_info.block.id }}">
                        <td class="p-1">{{ block_info.block.block_config }} <span class="badge badge-info">{{ block_info.block.user.first_name }} {{ block_info.block.user.last_name }}</span></td>
                        <td class="p-1">
                            <div>Cost: {% if block_info.voucher_applied.discounted_cost is not None %}
                                    <span class="superceded-cost">£{{ block_info.original_cost }}</span> £{{ block_info.voucher_applied.discounted_cost }}
                                {% else %}
                                    £{{ block_info.original_cost }}
                                {% endif %}
                            {% if block_info.voucher_applied.discounted_cost is not None %}
                            <br><span class="text-secondary"><small><em>Voucher code applied: {{ block_info.voucher_applied.code }}</em></small></span>
                            {% endif %}
                            <span
                                    id="remove-block-{{ block_info.block.id }}"
                                    class="remove-block float-right"
                                    data-block_id="{{ block_info.block.id }}"
                                    >
                                <a class="btn btn-sm btn-danger" href="#"><i class="fas fa-trash-alt"></i></a>
                            </span>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
              </tbody>
              <tfoot>
              <tr>
                  <td colspan="2">
                      <strong>TOTAL: £ <span id="total">{{ total_cost }}</span></strong>
                      <span
                          class="ajax-checkout-btn"
                          id="checkout-btn"
                          data-total="{{ total_cost }}"
                      >
                          <span id="payment-btn">{% include "booking/includes/payment_button.txt" %}</span>
                      </span>

                      <span id="paypal-btn-wrapper"><span id="paypal-checkout-btn"></span></span>

                      <a class="btn btn-xs btn-outline-primary" href="{% url 'booking:block_purchase' %}">Add more items</a>
                      <hr>
                          <form name="block_voucher_form" class="form-inline" method="post" action="">
                            {% csrf_token %}
                            <input name="code" type="text" required="required"/>
                            <input class="btn btn-sm btn-outline-info ml-2" type="submit" name="add_voucher_code" value="Apply voucher code"/>
                        </form>
                        <span class="errorlist"><ul>{% for error in voucher_add_error %}<li>{{ error }}</li>{% endfor %}</ul></span>
                      {% if applied_voucher_codes_and_discount %}
                      <hr class="mb-2">
                      <div><small><strong>Codes applied:</strong></small>
                          {% for applied_voucher_code, applied_voucher_discount in applied_voucher_codes_and_discount %}
                                <form class="form-inline mt-0 mb-1" method="post" action="">
                                    {% csrf_token %}
                                    <input name="code" type="hidden" value="{{ applied_voucher_code }}"/>
                                    <span class="mr-1 m-0 pb-1 pl-1 pr-1 pt-0 alert alert-info"><small><strong>{{ applied_voucher_code }}</strong> ({{ applied_voucher_discount }}%)</small></span>
                                    <button type="submit" name="remove_voucher_code" class="btn btn-sm btn-danger pb-1 pl-2 pr-2 pt-0"><small><i class="fas fa-trash-alt"></i></small></button>
                                </form>
                            {% endfor %}
                     </div>
                      {% endif %}

                  </td>
              </tr>
              </tfoot>
            </table>
    </div>

{% else %}
    <div class="col-12">
    <p>Your cart is empty</p>
    <p><a class="btn btn-xs btn-outline-primary" href="{% url 'booking:block_purchase' %}">Add items</a></p>
    </div>
{% endif %}
</div>

{% endblock content %}


{% block extra_js %}
<script type='text/javascript' src="{% static 'booking/js/shopping_basket_ajax.js' %}"></script>
{% endblock %}