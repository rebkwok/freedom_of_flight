{% extends "base.html" %}

{% load accounttags bookingtags static email_obfuscator %}

{% block extra_head %}
{% include 'common/includes/ajax_head.html' %}
{% endblock %}

{% block content %}

<div id="confirm-dialog"></div>

    {% include 'common/includes/view_as_user.html' %}

    <h2 class="mt-1">{{ title }}
    {% if not course %}
        {% for track_obj in tracks %}
            {% if track_obj != track %}
                <span class="expired expired-track">| <a class="expired" href="{% url 'booking:events' track_obj.slug %}">{{ track_obj.name }}</a></span>
            {% endif %}
        {% endfor %}
    {% endif %}

    </h2>

    <div class="row">
    {% if course %}
        <div class="col-12 mb-2">
        {% if request.user.is_authenticated %}
            <span id="course_button_pre_text">
                {{ book_course_button_options.pre_button_text }}
            </span>    
            
            {% if view_as_user|has_disclaimer %}
                {% if book_course_button_options.button == "book" %}
                <div
                    id="book_course_{{ course.id }}"
                    data-user_id="{{ view_as_user.id }}"
                    data-ref="course"
                    data-page="{{ request.GET.page }}"
                    data-course_id="{{ course.id }}"
                    class="ajax_course_events_btn">
                    {% include "booking/includes/course_events_button.txt" %}
                </div>
                {% elif book_course_button_options.button == "unenroll" %}
                    <form id="unenroll" class="mb-2" action="{% url 'booking:unenroll_course' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" id="user_id" name="user_id" value="{{ view_as_user.id }}">
                        <input type="hidden" id="course_id" name="course_id" value="{{ course.id }}">
                        <input type="hidden" id="ref" name="ref" value={% if course %}"course"{% else %}"events"{% endif %}>
                        <input type="submit" class="btn btn-warning" value="Unenroll">
                    </form>
                {% endif %}
            {% elif view_as_user|has_expired_disclaimer %}
                <span class="helptext float-right"><a href="{% url 'accounts:disclaimer_form' view_as_user.id %}">Update expired disclaimer</a> to book</span>
            {% else %}
                <span class="helptext float-right"><a href="{% url 'accounts:disclaimer_form' view_as_user.id %}">Complete a disclaimer</a> to book</span>
            {% endif %}

            <span id="course_button_post_text">
                {{ book_course_button_options.post_button_text }}
            </span>    
            
        {% endif %}
        </div>
    {% endif %}
    <div class="col-12 mb-2">
        {% if courses_available %}
            <span class="float-left"><a class="btn btn-outline-primary btn-sm" href="{% url 'booking:courses' track.slug %}">View courses</a></span>
        {% endif %}

        {% if course %}
                <span class="float-left mr-1"><a class="btn btn-outline-primary btn-sm" href="{% url 'booking:courses' course.event_type.track.slug %}">View courses</a></span>
                <span class="float-left"><a class="btn btn-outline-primary btn-sm" href="{% url 'booking:events' course.event_type.track.slug %}">View {{ course.event_type.track.pluralized_event_type_label }}</a></span>

        {% endif %}
        {% if request.user.is_authenticated %}<span class="float-right"><a class="btn btn-outline-primary btn-sm" href="{% url 'booking:bookings' %}">My Bookings</a></span>{% endif %}
    </div>    
    <div>
        {% if not course %}
        <form class="mt-2" method="get">
            {{ name_filter_form }}
        </form>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-12">
    {% if course.description %}
        <div class="row event-card event-card-header list-group-item-info">
            <div class="col-12 p-2">Details</div>
        </div>
        <div class="row event-card event-card-item p-2">{{ course.description|linebreaks }}</div>
    {% endif %}

    {% if events_by_date %}
        {% for date, events in events_by_date.items %}
            <div class="row event-card event-card-header list-group-item-secondary">
                <div class="col-12 p-1">{{ date|date:"D d M Y" }}</div>
            </div>
            {% for event in events %}
                <div class="row event-card event-card-item {% if event.is_past or event.cancelled %}list-group-item-secondary{% endif %}">
                {% with button_info=button_options|lookup_dict:event.id user_info=user_booking_info|lookup_dict:event.id %}
                    {% if button_info.open %}
                        {% if event.show_video_link %}
                            <div class="col-12 pt-1 pr-1"><a id="video_link_id_{{ event.id }}" class="btn btn-info btn-xs float-right" href="{{ event.video_link }}">Join online class</a></div>
                        {% elif event.event_type.is_online %}
                            <div class="col-12 pt-1 pr-1">
                            <span class="float-right" data-toggle="tooltip" title="Video link active 20 mins before class starts">
                                <span id="video_link_id_disabled_{{ event.id }}" class="btn btn-secondary btn-xs disabled float-right">Join online class</span>
                            </span>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    
                    <div class="col-1 pt-2 pb-2 pl-1">
                        <small>{{ event.start|date:"H:i"  }}-{{ event.end|date:"H:i" }}</small>

                    </div>
                    <div class="col-11 pt-2 pb-2">
                            <!-- Event name and info (availability, user blocks) on smaller screens -->
                            <span id="booked_tick_{{ event.id }}" {% if not button_info.open or not button_info.has_open_booking %}class="hidden"{% endif %}>
                                {% if button_info.in_basket %}
                                    <i class="text-secondary fas fa-shopping-cart"></i>
                                {% else %}
                                    <i class="text-success fas fa-check-circle"></i>
                                {% endif %}
                            </span>
                        <a href="{% url 'booking:event' event.slug %}"><span class="ninety-pct">{{ event.name }}</span></a>
                            <span class="d-inline-block d-sm-none" id="event_info_xs_{{event.id}}">
                            {% include 'booking/includes/event_info_xs.html' %}
                            </span>
                            <!-- availability, user blocks etc on larger screens plus course info on all -->
                            {% include 'booking/includes/events_info.html' %}
                    </div>

                    <div class="col-12 pr-1 pl-1 float-right">
                        <!-- booking buttons and info text -->
                        {% if request.user.is_authenticated %}
                            
                            {% if view_as_user|has_disclaimer %}
                                <span id="button_text_wrapper_{{ event.id }}" class="{% if not button_info.text_no_style %}helptext{% endif %} float-right col-12">
                                    <span class="float-right" id="button_text_{{ event.id }}">{{ button_info.text }}</span>
                                </span>
                                {% if button_info.buttons %}
                                <span class="float-right col-12">
                                    <span class="float-right">
                                    {% for button in button_info.buttons %}
                                        {% if button == "waiting_list" %}
                                                <span
                                                    id="waiting_list_button_{{ event.id }}"
                                                    data-event_id="{{ event.id }}"
                                                    data-user_id="{{ view_as_user.id }}"
                                                    class="ajax_events_waiting_list_btn">
                                                {% include "booking/includes/waiting_list_button.html" %}
                                                </span>
                                        {% elif button == "toggle_booking" %}
                                            <span
                                                id="book_{{ event.id }}"
                                                data-event_id="{{ event.id }}"
                                                data-course_id={% if event.course %}"{{ event.course.id }}"{% else %}""{% endif %}
                                                data-event_str="{{ event.name }} ({{ event.start|date:'D d b H:i'|title }})"
                                                data-user_id="{{ view_as_user.id }}"
                                                data-ref={% if course %}"course"{% else %}"events"{% endif %}
                                                data-page="{{ request.GET.page }}"
                                                data-show_warning={{ user_info.show_warning|yesno:"1,0" }}
                                                data-cancellation_allowed={{ event.event_type.allow_booking_cancellation|yesno:"1,0" }}
                                                class="ajax_events_btn">
                                                {% include "booking/includes/events_button.txt" %}
                                            </span>
                                        {% elif button == "add_to_basket" %}
                                                    <span 
                                                      id="add_to_basket_{{ event.id }}"
                                                      data-event_id="{{ event.id }}"
                                                      data-event_str="{{ event.name }} ({{ event.start|date:'D d b H:i'|title }})"
                                                      data-course_id={% if event.course %}"{{ event.course.id }}"{% else %}""{% endif %}
                                                      data-user_id="{{ view_as_user.id }}"
                                                      data-show_warning={{ user_info.show_warning|yesno:"1,0" }}
                                                      data-cancellation_allowed={{ event.event_type.allow_booking_cancellation|yesno:"1,0" }}
                                                      data-ref={% if course %}"course"{% else %}"events"{% endif %}
                                                      class="ajax_add_to_basket_btn"
                                                    > 
                                                    <span class="btn btn-xs btn-xs-wider btn-primary mb-1">
                                                        <i id="loader_{{ event.id }}"></i><i class="fas fa-shopping-cart"></i> Add drop-in</span>
                                                    </span>
                                        {% elif button == "add_course_to_basket" %}
                                                <span 
                                                    id="add_course_to_basket_{{ event.id }}"
                                                    data-course_id={% if event.course %}"{{ event.course.id }}"{% else %}""{% endif %}
                                                    data-event_id="{{ event.id }}"
                                                    data-user_id="{{ view_as_user.id }}"
                                                    data-ref={% if course %}"course"{% else %}"events"{% endif %}
                                                    class="ajax_add_course_to_basket_btn"
                                                > 
                                                <span class="btn btn-xs btn-xs-wider btn-primary mb-1"><i id="loader_course_{{ event.id }}"></i><i class="fas fa-shopping-cart"></i> Add course</span>
                                        {% elif button == "book_course" %}
                                            <span
                                                id="book_course_event_{{ event.id }}"
                                                data-event_id="{{ event.id }}"
                                                data-course_id="{{ event.course.id }}"
                                                data-user_id="{{ view_as_user.id }}"
                                                data-ref={% if course %}"course"{% else %}"events"{% endif %}
                                                data-page="{{ request.GET.page }}"
                                                class="ajax_book_course_events_btn">
                                                <span class="btn btn-xs btn-xs-wider btn-success mb-1"><i id="loader_book_course_{{ event.id }}"></i><i class="fas fa-clone"></i> Book course</span>
                                            </span>
                                        {% elif button == "unenroll" %}
                                            <form id="unenroll_course_from_event_{{ event.id }}" class="mb-2"    action="{% url 'booking:unenroll_course' %}" method="post">
                                                {% csrf_token %}
                                                <input type="hidden" id="user_id" name="user_id" value="{{ view_as_user.id }}">
                                                <input type="hidden" id="ref" name="ref" value={% if course %}"course"{% else %}"events"{% endif %}>
                                                <input type="hidden" id="course_id" name="course_id" value="{{ event.course.id }}">
                                                <input type="submit" class="btn btn-xs btn-xs-wider btn-warning mb-1" value="Unenroll course">
                                            </form>
                                        {% elif button == "payment_options" %}
                                            <span>
                                            {% if event.course %}
                                                <a 
                                                  id="payment_options_{{ event.id }}"  
                                                  class="btn btn-xs btn-xs-wider btn-outline-dark mb-1" 
                                                  href="{% url 'booking:course_purchase_options' event.course.slug %}"
                                                >Payment Plans</a>
                                            {% else %}
                                                <a 
                                                  id="payment_options_{{ event.id }}"
                                                  class="btn btn-xs btn-xs-wider btn-outline-dark mb-1" 
                                                  href="{% url 'booking:event_purchase_options' event.slug %}"
                                                >Payment Plans</a>
                                            {% endif %}
                                            </span>
                                        {% elif button == "view_cart" %}    
                                        {% else %}
                                            ###unknown###{{ button }}###
                                        {% endif %}
                                    {% endfor %}
                                    <span id="view_cart_{{ event.id }}" {% if not "view_cart"|inlist:button_info.buttons %} class="hidden"{% endif %}>
                                        <a class="btn btn-xs btn-xs btn-xs-wider btn-outline-primary mb-1" href="{% url 'booking:shopping_basket' %}">
                                        <i class="fas fa-shopping-cart"></i> View cart
                                        </a>
                                    </span>
                                  </span> 
                                </span> 
                                {% endif %}
             
                            {% elif view_as_user|has_expired_disclaimer %}
                                <span class="helptext float-right"><a href="{% url 'accounts:disclaimer_form' view_as_user.id %}">Update expired disclaimer</a> to book</span>
                            {% else %}
                                <span class="helptext float-right"><a href="{% url 'accounts:disclaimer_form' view_as_user.id %}">Complete a disclaimer</a> to book</span>
                            {% endif %}
                        {% else %}
                            <span class="helptext float-right"><a href="{% url 'account_login' %}?next={{request.get_full_path}}">Log in</a> or <a href="{% url 'account_signup' %}">register</a> to book</span>
                        {% endif %}
                    </div>

                {% endwith %}
                </div>
            {% endfor %}
        {% endfor %}

        {% if page_events.has_other_pages %}
        <!--NAVIGATION-->
            <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if page_events.has_previous %}
                <li class="page-item">
                <a class="page-link" href="?page={{ page_events.previous_page_number }}&event_name={{ request.GET.event_name }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
                </li>
                {% else %}
                <a class="page-link" disabled=disabled href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                    <span class="sr-only">Previous</span>
                </a>
                {% endif %}
                <li class="page-item"><a class="page-link" href="#">Page {{ page_events.number }} of {{ page_events.paginator.num_pages }}</a></li>

            <li class="page-item">
                {% if page_events.has_next %}
                <a class="page-link" href="?page={{ page_events.next_page_number }}&event_name={{ request.GET.event_name }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
                {% else %}
                <a class="page-link" disabled=disabled href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                    <span class="sr-only">Next</span>
                </a>
                {% endif %}
            </li>
            </ul>
            </nav>
        {% endif %}
    {% else %}
        <p>No events scheduled.</p>
    {% endif %}
    </div>
</div>

{% endblock content %}


{% block extra_js %}
<script type='text/javascript' src="{% static 'booking/js/events_booking_ajax-v5.js' %}"></script>
<script type='text/javascript' src="{% static 'booking/js/add_to_basket_ajax-v1.js' %}"></script>
{% endblock %}